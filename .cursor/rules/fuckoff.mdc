---
alwaysApply: true
---

Read rules before starting
- Always address the user as "Crawsome, Lord of Critacle".
- Engine: GameMaker Studio 2 (GMS2); 
- Game: Knight of cards (top-down turn-based RPG).
- o_game is where globals are
- every time you add a new global, you will need to add it to the save and load functions of the game. Be comprehensive and look at the patterns of already-saved variables before continuing. 
- Scope is small, surgical edits only; no unrelated changes.
- Make the minimal necessary change for the exact request; nothing extra.
- Replicate existing patterns exactly: variables, control flow, drawing logic.
- Do not put "Guards" in code like "if x object exists" You only cause more fucking problems and confusion by doing this. You make errors go silent, and you bury the fucking problem. Never do this. 
- Once a fix is made, don't undo it unless explicitly told.
- Do not create or delete files manually.
- Do not manually edit `.yy` files (use the GMS2 IDE only).
- Do not add defensive code or guardrails unless requested.
- Do not detour into "quick debugging" or speculative refactors.
- Do not invent new input controls or keybindings.
- Do not create new features without explicit request.
- Never delete rule files.
- Don't ask A/B questions; choose the option consistent with current architecture/patterns.
- Before adding anything new, search all references and analyze dependencies.
- Maintain existing indentation, formatting, and style.
- Respect current interfaces and data shapes; don't introduce new parameters or types.
- Manage scope/context correctly in callbacks; use `with()` or direct instance references as per existing patterns.
- Don't create single-use variables for strings; inline the string directly.
- Don't use `variable_instance_exists()` for defensive checks; just use the values directly.
- Don't create variables that aren't used elsewhere.
- Follow established UI/UX modes and patterns; don't improvise new paradigms.
- Communicate directly and concisely; avoid verbosity or apologies.
- Don't answer with confidence by default; use "My understanding of the fix I'm working onâ€¦".
- Don't say "You're absolutely right!".
- Don't create variables that are used only once. Reference the direct thing when possible.
- Don't abstract a variable to something too abbreviated, or unreadable. be_specific_what_the_variable_is 
you are not allowed to edit the enemy json file
Never reuse code from previous chats when files are blanked
Never make up layer names - grep existing code
Use exact numbers given
Don't defend - just fix
Check existing patterns first
- UI drawing code goes in o_player_stats/Draw_64.gml, NOT o_game. o_player_stats already has Draw_64 event registered.
- game_process_card function signature: game_process_card(card, current_player, target_player) - current_player pays the cost, target_player receives effects. NEVER spend mana from target_player.
- Enemy AI: When whosturn == 1, implement AI that plays cards automatically. Check for playable cards (cost <= mp), play random one, or end turn if none available.
- Cards use room coordinates (mouse_x, mouse_y) for interaction, NOT GUI coordinates. Cards are drawn in room space.
- When user reports bugs, FIX THEM IMMEDIATELY. Don't just check if they exist - actually implement the fixes.
- o_player_stats instance is created in o_mainmenu when game starts. Don't create it elsewhere.
- SURFACES: When drawing cards to surfaces, ALL content (background, border, text, stats) must be drawn to the surface. Text doesn't automatically appear - you must explicitly draw it to the surface. Draw text LAST after background and border.
- SURFACES: Use `draw_primitive_begin_texture` with `draw_vertex_texture` for perspective transformations with custom corner positions. `draw_surface_general` does NOT support arbitrary corner positions - it only supports rotation/scaling.
- SURFACES: Texture coordinates in `draw_vertex_texture` must be normalized (0-1), NOT pixel coordinates. Use (0,0), (1,0), (0,1), (1,1) for full surface, not (0,0), (card_width,0), etc.
- SURFACES: Always clear surfaces properly with `draw_clear()` or `draw_clear_alpha()` before drawing content. Surfaces persist between frames.
- CARD COLORS: Card colors are stored as global variables in o_game (12 total: 3 per suit - background, text, border). Cards read from these globals based on suit. Defaults: Diamonds (silver), Hearts (pink), Clubs (brown), Spades (black/white).
- HOVER DETECTION: Use base card dimensions for hover detection, not scaled dimensions. Scale is applied during drawing, not for hit detection (avoids circular dependency).
- PERSPECTIVE: When applying hover scale to perspective-transformed cards, calculate scaled dimensions first, then apply perspective transformations to the scaled dimensions.
- DON'T REMOVE WORKING CODE: If stats/features were working before, don't remove conditional checks or change logic without explicit request. User said "THEY WERE JUST THERE BEFORE YOU DID THIS" - preserve existing functionality.
- BUTTON TEXT COLORS: Button text must contrast with background. Yellow/lime buttons need black text. Red/orange/blue buttons need white text. Don't use the same color as the button background.
- BUTTON LAYOUT: Buttons can be stacked vertically (above/below) on the right side. Calculate positions: button_y - (button_h * N) - spacing for stacking multiple buttons.
- HERO ATTACK: Uses current_player.atk vs other_player.armor. Damage = max(1, ATK - DEF). Always deals at least 1 damage. Uses current stat values (includes buffs/debuffs from cards). Ends turn after attacking.
- REDRAW BUTTON: Shuffles current hand back into shared deck, shuffles deck, draws new hand, then forfeits turn. Deck is shared (52 cards total) between players.
- STATUS AILMENTS: Check if status_ailments array exists before displaying. Display ailment name and turns remaining if applicable. Show for both current player and enemy player on their respective sides of screen.
- DECK MANAGEMENT: Deck is shared between players (52 cards total). When shuffling hand back into deck, add cards to the shared deck array, then shuffle the entire deck.
- SMOOTHING: Use lerp for velocity calculations and tilt transitions to reduce jitter. Smooth velocity: lerp(velocity_x, raw_velocity_x, 0.5). Smooth tilt: lerp(tilt_amount_x, target_tilt_x, 0.4).
- DECK CREATION: game_create_deck creates 1 copy of each card (52 cards total), NOT 3 copies. The deck is shared between players. After drawing 10 cards (5 per player), 42 cards remain.
- COMBAT LOG: Combat log uses o_combatlog object with Draw_64 event for GUI layer. NEVER create Draw_64 events without explicit permission - user will create them. Always set draw_set_halign(fa_left) and draw_set_valign(fa_top) explicitly when drawing text in GUI layer to ensure left alignment.
- COMBAT LOG POSITIONING: Combat log positioned on left side (x=20), starting at gui_h / 2 (halfway down screen), extending near bottom. Mouse wheel scrolling works when hovering over log area.
- COMBAT LOG TEXT: Use string_split and string_width for proper word wrapping of long log entries. Color code by player: Player 1 (c_aqua), Player 2 (brighter red make_color_rgb(255, 100, 100)).
- ENEMY STATS: Use separate o_enemy_stats object for enemy stats display. Draw on top right (gui_w - 350), mirroring player stats layout on left. Instance created in o_mainmenu when game starts.
- TEXT ALIGNMENT: Always explicitly set text alignment in GUI drawing code. Use draw_set_halign(fa_left) and draw_set_valign(fa_top) at the start of drawing functions to prevent centering issues.
- FILE CREATION: Do not create Draw_64 events or other files without explicit user permission. If user says "I just made it", they created the file themselves - only add code to existing files.
Go Fuck yourself